# Calendar Invite API (Create Host Event)

## Overview

This API creates a **confirmed event** on the host's primary Google Calendar and (optionally) sends invitations to attendees.

- Wraps `CalendarService.createHostEvent` in `calendar.ts`
- Used after consensus / slot selection to actually schedule the event

Backend implementation lives in:

- Route: `agents/scheduler/api/calendar.routes.ts`
- Core logic: `agents/scheduler/calendar.ts` (`CalendarService.createHostEvent` and `createHostEvent` helper)

---

## HTTP Endpoint

- **Method:** `POST`
- **Path:** `/api/calendar/invite`

### Request Body

```json
{
  "slot": "2025-12-02T15:00:00.000Z",
  "title": "Coffee chat with Milan",
  "durationMinutes": 45,
  "inviteeEmails": ["milan@example.com"],
  "location": "Spangler Cafe",
  "description": "Scheduled via Gatherly",
  "hostId": "single_host_demo"
}
```

Fields:

- **slot** (string, required)
  - ISO-8601 start time in UTC (e.g., `2025-12-02T15:00:00.000Z`)
- **title** (string, required)
  - Event title as it will appear on the calendar
- **durationMinutes** (number, required)
  - Length of the meeting in minutes
- **inviteeEmails** (string[], optional)
  - List of attendee email addresses; can be empty or omitted
- **location** (string, optional)
  - Free-form location string (e.g., "Spangler Cafe", "Zoom")
- **description** (string, optional)
  - Event description; if omitted, a default "Scheduled via Gatherly" message is used
- **hostId** (string, optional for now)
  - Identifier for the host whose Google Calendar should be used.
  - If omitted, the backend currently falls back to a demo host ID (e.g., `single_host_demo`). In a real system this will come from the authenticated user and a DB-backed token lookup.

Additional behavior from implementation:

- **hostId** is currently hard-coded / defaulted in the route as `"single_host_demo"` for demo purposes.
- **timeZone** is currently fixed to `"America/New_York"` in the route.

> NOTE: In a full multi-user version, `hostId` and `timeZone` would come from the authenticated user / profile instead of being hard-coded.

### Response Body

```json
{
  "eventId": "evt_1701369600000_single_h",
  "calendarEventId": "random-google-event-id"
}
```

Fields:

- **eventId** (string)
  - Internal event identifier generated by the service (not Google-specific)
- **calendarEventId** (string)
  - The underlying Google Calendar event ID

### Error Responses

- `400 Bad Request`
  - Returned if any required field is missing:

    ```json
    { "error": "slot, title, and durationMinutes are required" }
    ```

- `500 Internal Server Error`
  - Returned if there is a failure talking to Google Calendar or another unexpected error:

    ```json
    { "error": "Failed to create calendar invite" }
    ```

---

## Behavioral Details (from `CalendarService.createHostEvent`)

Given a valid request, the service will:

1. Fetch OAuth tokens for the host (currently from environment variables for testing).
2. Set credentials on a Google Calendar client.
3. Compute the event **end time** from `slot` + `durationMinutes`.
4. Build a Google Calendar event resource:
   - `summary` from `title`
   - `description` from input or a default string
   - `location` from input, optional
   - `start` / `end` with `dateTime` and `timeZone`
   - `attendees` mapped from `inviteeEmails`
   - `reminders.useDefault = true`
5. Call `calendar.events.insert` with `sendUpdates: 'all'` so attendees get email invites.
6. Return `{ eventId, calendarEventId }`.

If Google Calendar does not return an ID, the service throws an internal `CalendarError`.

---

## Example Usage (Frontend)

### When to call this API

1. User enters a natural-language request.
2. Frontend calls **Scheduler API** (`/api/schedule/suggest`) to get 1–3 candidate slots.
3. User selects a slot and confirms the details (title, location, attendees, description).
4. Frontend calls **Calendar Invite API** (`/api/calendar/invite`) to create the real calendar event.

### Fetch call

```ts
interface CreateInviteRequest {
  slot: string; // ISO-8601 UTC
  title: string;
  durationMinutes: number;
  inviteeEmails?: string[];
  location?: string;
  description?: string;
}

interface CreateInviteResponse {
  eventId: string;
  calendarEventId: string;
}

async function createCalendarInvite(payload: CreateInviteRequest) {
  const res = await fetch('/api/calendar/invite', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const error = await res.json().catch(() => ({}));
    throw new Error(error.error || 'Failed to create calendar invite');
  }

  const data = await res.json();
  return data as CreateInviteResponse;
}
```

### Minimal end-to-end flow

- **Step 1:** Call `/api/schedule/suggest` with the user’s free-text request.
- **Step 2:** Show proposed slots and let the user pick one.
- **Step 3:** Call `/api/calendar/invite` with the chosen slot, title, duration, and invitees.
- **Step 4:** On success, show a confirmation screen (optionally include a "View in Calendar" link when you map `calendarEventId` to a Google Calendar URL).
